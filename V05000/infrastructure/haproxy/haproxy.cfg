# HAProxy Configuration for Fanatico L1 v0.5.0.0
# Load Balancer for RPC Nodes and PostgreSQL Cluster
# January 29, 2026

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL/TLS settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Tuning
    maxconn 50000
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-keep-alive 10s
    timeout check   5s
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# Stats page
#---------------------------------------------------------------------
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:${HAPROXY_STATS_PASSWORD}
    stats admin if LOCALHOST

#---------------------------------------------------------------------
# RPC HTTP Frontend (Port 8545)
#---------------------------------------------------------------------
frontend rpc_http
    bind *:8545
    mode http

    # Options
    option http-server-close
    option forwardfor except 127.0.0.0/8

    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # CORS headers (if needed)
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "POST, GET, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type"

    # Health check endpoint
    acl is_health path /health
    use_backend health_check if is_health

    # Default to RPC backend
    default_backend rpc_nodes

#---------------------------------------------------------------------
# RPC WebSocket Frontend (Port 8546)
#---------------------------------------------------------------------
frontend rpc_websocket
    bind *:8546
    mode http

    # WebSocket detection
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr_beg(Host) -i ws

    # Options for WebSocket
    option http-server-close
    option forwardfor except 127.0.0.0/8
    timeout client 3600s
    timeout server 3600s

    # Default to WebSocket backend
    default_backend websocket_nodes

#---------------------------------------------------------------------
# PostgreSQL Frontend (Port 5432) - via Patroni
#---------------------------------------------------------------------
frontend postgresql
    bind *:5432
    mode tcp
    option tcplog

    # Connection limits
    maxconn 5000
    timeout client 30m

    default_backend postgresql_primary

#---------------------------------------------------------------------
# PostgreSQL Read Replicas (Port 5433)
#---------------------------------------------------------------------
frontend postgresql_readonly
    bind *:5433
    mode tcp
    option tcplog

    # Connection limits
    maxconn 5000
    timeout client 30m

    default_backend postgresql_replicas

#---------------------------------------------------------------------
# RPC Backend - HTTP
#---------------------------------------------------------------------
backend rpc_nodes
    mode http
    balance roundrobin
    option httpchk POST /
    http-check send hdr Content-Type application/json body "{\"jsonrpc\":\"2.0\",\"method\":\"eth_chainId\",\"params\":[],\"id\":1}"
    http-check expect string "0x2964619c7"

    # Health check settings
    default-server inter 3s fall 3 rise 2

    # RPC nodes - replace with actual IPs
    server rpc1 10.0.1.10:8545 check
    server rpc2 10.0.1.11:8545 check
    server rpc3 10.0.1.12:8545 check

#---------------------------------------------------------------------
# RPC Backend - WebSocket
#---------------------------------------------------------------------
backend websocket_nodes
    mode http
    balance roundrobin

    # WebSocket specific settings
    timeout server 3600s
    timeout tunnel 3600s

    # Sticky sessions for WebSocket (important for subscriptions)
    stick-table type ip size 100k expire 30m
    stick on src

    # Health check (basic TCP)
    option httpchk GET /health
    default-server inter 10s fall 3 rise 2

    # WebSocket nodes - replace with actual IPs
    server ws1 10.0.1.10:8546 check
    server ws2 10.0.1.11:8546 check
    server ws3 10.0.1.12:8546 check

#---------------------------------------------------------------------
# PostgreSQL Primary Backend (via Patroni)
#---------------------------------------------------------------------
backend postgresql_primary
    mode tcp
    option httpchk GET /primary
    http-check expect status 200

    # Patroni REST API for health checks
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Database nodes - Patroni REST API on port 8008
    server db1 10.0.2.10:5432 check port 8008
    server db2 10.0.2.11:5432 check port 8008
    server db3 10.0.2.12:5432 check port 8008

#---------------------------------------------------------------------
# PostgreSQL Replicas Backend (Read-only)
#---------------------------------------------------------------------
backend postgresql_replicas
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200

    # Patroni REST API for health checks
    default-server inter 3s fall 3 rise 2

    # Database nodes - read from replicas
    server db1 10.0.2.10:5432 check port 8008
    server db2 10.0.2.11:5432 check port 8008
    server db3 10.0.2.12:5432 check port 8008

#---------------------------------------------------------------------
# Health Check Backend
#---------------------------------------------------------------------
backend health_check
    mode http
    http-request return status 200 content-type "application/json" string "{\"status\":\"healthy\",\"version\":\"v0.5.0.0\"}"
