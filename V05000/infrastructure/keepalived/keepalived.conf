# Keepalived Configuration for Fanatico L1 v0.5.0.0
# HAProxy High Availability with VRRP
# January 29, 2026
#
# Deploy this on both HAProxy nodes with different priorities:
# - Primary (haproxy1): priority 101
# - Standby (haproxy2): priority 100

global_defs {
    router_id FANATICO_LB
    script_user root
    enable_script_security

    notification_email {
        alerts@fanati.co
    }
    notification_email_from keepalived@fanati.co
    smtp_server localhost
    smtp_connect_timeout 30
}

# HAProxy health check script
vrrp_script check_haproxy {
    script "/usr/bin/killall -0 haproxy"
    interval 2
    weight 2
    fall 3
    rise 2
}

# Alternative: more thorough HAProxy check
vrrp_script check_haproxy_detailed {
    script "/etc/keepalived/check_haproxy.sh"
    interval 5
    weight 2
    fall 3
    rise 2
}

# VRRP Instance for RPC Virtual IP
vrrp_instance FANATICO_RPC_VIP {
    state MASTER  # BACKUP on secondary node
    interface eth0
    virtual_router_id 51
    priority 101  # 100 on secondary node

    # Authentication
    authentication {
        auth_type PASS
        auth_pass ${KEEPALIVED_AUTH_PASS}
    }

    # Virtual IP address
    virtual_ipaddress {
        10.0.0.100/24 dev eth0 label eth0:vip
    }

    # Track HAProxy status
    track_script {
        check_haproxy
    }

    # Notification scripts
    notify_master "/etc/keepalived/notify.sh MASTER"
    notify_backup "/etc/keepalived/notify.sh BACKUP"
    notify_fault  "/etc/keepalived/notify.sh FAULT"

    # Preemption settings
    nopreempt  # Don't switch back automatically (more stable)

    # VRRP advertisement interval (seconds)
    advert_int 1

    # Use unicast instead of multicast (recommended for cloud)
    unicast_src_ip ${THIS_NODE_IP}
    unicast_peer {
        ${OTHER_NODE_IP}
    }
}

# VRRP Instance for Database Virtual IP (optional - separate VIP)
vrrp_instance FANATICO_DB_VIP {
    state MASTER  # BACKUP on secondary node
    interface eth0
    virtual_router_id 52
    priority 101  # 100 on secondary node

    authentication {
        auth_type PASS
        auth_pass ${KEEPALIVED_AUTH_PASS}
    }

    virtual_ipaddress {
        10.0.0.101/24 dev eth0 label eth0:dbvip
    }

    track_script {
        check_haproxy
    }

    notify_master "/etc/keepalived/notify.sh MASTER DB"
    notify_backup "/etc/keepalived/notify.sh BACKUP DB"
    notify_fault  "/etc/keepalived/notify.sh FAULT DB"

    nopreempt
    advert_int 1

    unicast_src_ip ${THIS_NODE_IP}
    unicast_peer {
        ${OTHER_NODE_IP}
    }
}
